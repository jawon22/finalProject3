<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="attend">
	
	<!-- C 등록 -->
	<!-- 출근 버튼 눌렀을 때 -->
	<insert id="save">
		insert into attend(emp_no, ATTEND_NO, ATTEND_START) values(#{empNo}, attend_seq.nextval, sysdate)
	</insert>
	
	<!-- U 수정 -->
	<!-- 퇴근 버튼 눌렀을 때 -->
	<update id="update">
		update attend set attend_end = sysdate where emp_no = #{empNo}
		and trunc(attend_start) = trunc(sysdate)
	</update>
	
	<!-- R 목록, 상세 -->
	<!-- 사번별로 지정한 기간으로 날짜가 생성되고, 근무시간이 추가돼서 나오는 구문 -->
	<select id="selectListByEmpNo" resultType="AttendWorkingTimesVO">
		SELECT
		    TMP.DT,
		    ATT.attend_no,
		    ATT.emp_no,
		    ATT.attend_start,
		    ATT.attend_end,
		    NVL((ATT.attend_end - ATT.attend_start) * 24, 0) AS "working_times"
		FROM (
		    SELECT
		        trunc(to_date(#{attendBeginDate}, 'YYYY-MM-DD') + (LEVEL - 1)) AS DT
		    FROM dual
		    <![CDATA[
		    CONNECT BY LEVEL <= to_date(#{attendEndDate}, 'YYYY-MM-DD') - to_date(#{attendBeginDate}, 'YYYY-MM-DD') + 1
		    ]]>
		) TMP
		LEFT JOIN (
		    SELECT *
		    FROM attend
		    WHERE emp_no = #{empNo}
		) ATT ON to_char(TMP.DT, 'YYYY-MM-DD') = to_char(ATT.attend_start, 'YYYY-MM-DD')
		ORDER BY TMP.DT desc
	</select>
	
	<select id="selectByEmpTotalWorkingTime" resultType="int">
		SELECT
		    --TO_CHAR(TMP.DT, 'YYYY-MM') AS year_month,
		    SUM(NVL((ATT.attend_end - ATT.attend_start) * 24, 0)) AS total_working_times
		FROM (
		    SELECT
		        trunc(to_date(#{yearMonth}, 'YYYY-MM')) AS DT
		    FROM dual
		) TMP
		LEFT JOIN (
		    SELECT *
		    FROM attend
		    WHERE (TO_CHAR(attend_start, 'YYYY-MM') = #{yearMonth}
		           OR TO_CHAR(attend_end, 'YYYY-MM') = #{yearMonth})
		    AND emp_no = #{empNo}
		) ATT ON TO_CHAR(TMP.DT, 'YYYY-MM') = TO_CHAR(ATT.attend_start, 'YYYY-MM')
		GROUP BY TO_CHAR(TMP.DT, 'YYYY-MM')
	</select>
	
	
	
	
</mapper>







